from flask import Flask, render_template, request
import os
import google.generativeai as genai
from dotenv import load_dotenv

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
load_dotenv()

app = Flask(__name__)

# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º API-–∫–ª—é—á Google
# –ù–∞ Render –µ–≥–æ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤ Environment Variables –ø–æ–¥ –∏–º–µ–Ω–µ–º GOOGLE_API_KEY
api_key = os.getenv("GOOGLE_API_KEY")
if api_key:
    genai.configure(api_key=api_key)
else:
    # –≠—Ç–∞ –æ—à–∏–±–∫–∞ –±—É–¥–µ—Ç –≤–∏–¥–Ω–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ, –µ—Å–ª–∏ –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω
    print("‚ùå –û—à–∏–±–∫–∞: GOOGLE_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –∑–∞–¥–∞–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è.")


# –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –∫—Ä–∞—Ç–∫–æ—Å—Ç—å –∏ —Å–æ–≤–µ—Ç—ã –ø–æ —Ñ–æ—Ç–æ
PROMPT_TEMPLATE = """
–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç –∫–æ—Ä–æ—Ç–∫–∏–µ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –¥–ª—è Avito.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–¥–∞—é—â–µ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –∏ –¥–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —Ñ–æ—Ç–æ.

**–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –æ–±—ä—è–≤–ª–µ–Ω–∏—è:**
1.  **–ó–∞–≥–æ–ª–æ–≤–æ–∫:** –î–æ 50 —Å–∏–º–≤–æ–ª–æ–≤. –Ø—Ä–∫–∏–π, —Å –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–æ–º. –ë–µ–∑ –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞–∫–æ–≤.
2.  **–¶–µ–Ω–∞:** –£–∫–∞–∂–∏ –∫–∞–∫ –µ—Å—Ç—å.
3.  **–û–ø–∏—Å–∞–Ω–∏–µ:** –°—Ç—Ä–æ–≥–æ –¥–æ 250 —Å–∏–º–≤–æ–ª–æ–≤.
    * –û–¥–∏–Ω-–¥–≤–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö –∞–±–∑–∞—Ü–∞.
    * –ü–µ—Ä–≤—ã–π –∞–±–∑–∞—Ü ‚Äî –∫–ª—é—á–µ–≤–∞—è –≤—ã–≥–æ–¥–∞.
    * –í—Ç–æ—Ä–æ–π ‚Äî —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏ –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é.
    * –ò—Å–ø–æ–ª—å–∑—É–π 1-2 —ç–º–æ–¥–∑–∏ –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–æ–≤.
    * –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª–æ–≤–∞ ¬´–±/—É¬ª, ¬´—Å—Ç–∞—Ä—ã–π¬ª. –ó–∞–º–µ–Ω—è–π –Ω–∞ ¬´–≤ –æ—Ç–ª–∏—á–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏¬ª, ¬´–Ω–∞–¥–µ–∂–Ω—ã–π¬ª.
4.  **–•—ç—à—Ç–µ–≥–∏:** 3-4 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ö—ç—à—Ç–µ–≥–∞ –≤ –∫–æ–Ω—Ü–µ.

**–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Å–æ–≤–µ—Ç–æ–≤ –ø–æ —Ñ–æ—Ç–æ:**
* –î–∞–π 2-3 –∫–æ—Ä–æ—Ç–∫–∏—Ö, –Ω–æ –ø–æ–ª–µ–∑–Ω—ã—Ö —Å–æ–≤–µ—Ç–∞, –∫–∞–∫ –ª—É—á—à–µ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä.

**–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ (—Å—Ç—Ä–æ–≥–æ —Å–æ–±–ª—é–¥–∞–π –µ–≥–æ):**

**–ó–∞–≥–æ–ª–æ–≤–æ–∫:** <—Ç–µ–∫—Å—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞>
**–¶–µ–Ω–∞:** <—Ü–µ–Ω–∞> —Ä—É–±.

**–û–ø–∏—Å–∞–Ω–∏–µ:**
<—Ç–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è>

#<—Ö—ç—à—Ç–µ–≥1> #<—Ö—ç—à—Ç–µ–≥2> #<—Ö—ç—à—Ç–µ–≥3>

---
**üí° –°–æ–≤–µ—Ç—ã –ø–æ —Ñ–æ—Ç–æ:**
* <–°–æ–≤–µ—Ç 1>
* <–°–æ–≤–µ—Ç 2>

**–í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:** "{}"
"""

MAX_INPUT_LENGTH = 500

def generate_ai_response(user_input: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç Google Gemini API —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫.
    """
    if not api_key:
        return "‚ùå –û—à–∏–±–∫–∞: API-–∫–ª—é—á –¥–ª—è Google –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ."

    if not user_input.strip():
        return "‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ —Ç–æ–≤–∞—Ä–∞."

    if len(user_input) > MAX_INPUT_LENGTH:
        return f"‚ö†Ô∏è –í–∞—à–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ ‚Äî {MAX_INPUT_LENGTH} —Å–∏–º–≤–æ–ª–æ–≤."

    prompt = PROMPT_TEMPLATE.format(user_input.strip())

    try:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å
        model = genai.GenerativeModel('gemini-1.5-flash-latest')
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
        response = model.generate_content(prompt)
        
        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
        return response.text.strip()

    except Exception as e:
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ API
        return f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Gemini API: {e}"

@app.route("/", methods=["GET", "POST"])
def index():
    result = None
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º user_input –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –æ–Ω–∞ –≤—Å–µ–≥–¥–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∞
    user_input = "" 
    
    if request.method == "POST":
        user_input = request.form.get("user_input", "")
        result = generate_ai_response(user_input)
        
    # –¢–µ–ø–µ—Ä—å —ç—Ç–∞ —Å—Ç—Ä–æ–∫–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –¥–ª—è GET, –∏ –¥–ª—è POST –∑–∞–ø—Ä–æ—Å–æ–≤
    return render_template("index.html", result=result, user_input=user_input)


if __name__ == "__main__":
    # debug=False –ª—É—á—à–µ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞, –Ω–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–∏ True —É–¥–æ–±–Ω–µ–µ
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 8080)), debug=True)
